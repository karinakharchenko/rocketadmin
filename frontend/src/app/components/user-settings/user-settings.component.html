<app-alert></app-alert>
<app-alert *ngIf="currentUser.id && !currentUser.isActive" [alert]="emailVerificationWarning"></app-alert>

<div class="page">
    <h1 class="mat-h1">
        Account settings
    </h1>

    <div class="user-settings mat-body-1">
        <form class="user-settings__section-heading">
            <mat-form-field appearance="outline" class="user-settings__name">
                <mat-label>Name</mat-label>
                <input matInput [(ngModel)]="userName" name="user-name" #nameField="ngModel" data-test-id="user-name-input">
            </mat-form-field>
            <button type="button" mat-button color="primary" data-test-id="save-user-name-button"
                class="user-settings__save-button"
                (click)="changeUserName()"
                [disabled]="!nameField.dirty || submittingChangedName">
                Save
            </button>
        </form>


        <div class="user-settings__section-heading">
            <strong>Email:</strong>
            <button mat-button color="primary" data-test-id="change-user-email-button"
                class="user-settings__button"
                [disabled]="!currentUser.isActive"
                (click)="changeEmail()">
                Change email
            </button>
        </div>
        <span class="user-settings__value">{{currentUser.email}}</span>

        <div class="user-settings__section-heading">
            <strong>Password:</strong>
            <a mat-button routerLink="/change-password" color="primary" data-test-id="change-user-password-link"
                class="user-settings__button">
                Change password
            </a>
        </div>
        <span class="user-settings__value">********</span>


        <div class="user-settings__section-heading">
            <strong>Current plan:</strong>
            <a *ngIf="currentUser.portal_link; else updgadePageLink" mat-button color="accent"
                class="upgrade-button"
                [href]="currentUser.portal_link" target="_blank">
                Manage payment settings
            </a>
            <ng-template #updgadePageLink>
                <a mat-button color="accent" class="upgrade-button"
                    routerLink="/upgrade">
                    Manage payment settings
                </a>
            </ng-template>
        </div>
        <span class="user-settings__value">
            <span class="user-settings__value_capitalized">{{currentPlan}}</span>
            <span *ngIf="currentPlan !== 'Free'">
                ({{ isAnnually ? 'annually' : 'monthly' }})
            </span>
        </span>

        <div>
            <mat-slide-toggle [(ngModel)]="currentUser.is_2fa_enabled"
                [disabled]="!currentUser.isActive"
                (change)="switch2FA($event)">
                Two-factor authentication
            </mat-slide-toggle>
            <div *ngIf="is2FAswitchingOnSettingsShown" class="qr-verification">
                <p class="mat-body-1">Scan this QR code with 2FA application</p>
                <img [src]="secondFAQRCode" class="qr-verification-image" alt="qr">
                <mat-form-field appearance="outline" class="user-settings__name">
                    <mat-label>Enter the code from your authenticator</mat-label>
                    <input matInput [(ngModel)]="authCode" name="code" #codeField="ngModel">
                </mat-form-field>
                <button type="button" mat-button color="primary"
                    (click)="verify2FA()">
                    Enable
                </button>
            </div>
            <div *ngIf="is2FAswitchingOffSettingsShown" class="qr-verification">
                <mat-form-field appearance="outline" class="user-settings__name">
                    <mat-label>Enter the code from your authenticator</mat-label>
                    <input matInput [(ngModel)]="authCode" name="code" #codeField="ngModel">
                </mat-form-field>
                <button type="button" mat-button color="primary"
                    (click)="switchOff2FA()">
                    Disable
                </button>
            </div>


        </div>
    </div>

    <button mat-button class="delete-button"
        type="button"
        (click)="confirmDeleteAccount()">
        Delete account
    </button>
</div>
